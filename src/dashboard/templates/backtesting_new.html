{% extends "base_neon.html" %}

{% block title %}Backtesting - Trading Bot{% endblock %}
{% block page_title %}Backtesting{% endblock %}

{% block content %}
<!-- Backtest Configuration -->
<div class="dashboard-grid">
    <div class="card card-neon-cyan mb-6">
        <h2 class="text-lg font-bold mb-6">Backtest Konfiguration</h2>
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div class="form-group">
                <label class="form-label">Start Datum</label>
                <input type="date" id="start-date" class="form-input" value="">
            </div>
            <div class="form-group">
                <label class="form-label">End Datum</label>
                <input type="date" id="end-date" class="form-input" value="">
            </div>
            <div class="form-group">
                <label class="form-label">Initial Equity ($)</label>
                <input type="number" id="initial-equity" class="form-input" value="10000" min="1000" step="1000">
            </div>
            <div class="form-group">
                <label class="form-label">Strategien</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="strat-ensemble" checked> Ensemble
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="strat-momentum" checked> Momentum
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="strat-mean" checked> Mean Reversion
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="strat-breakout" checked> Breakout
                    </label>
                </div>
            </div>
            <button id="backtest-start-btn" onclick="startBacktest()" class="btn btn-primary btn-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Backtest starten
            </button>
            <button id="backtest-cancel-btn" onclick="cancelBacktest()" class="btn btn-danger btn-lg hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Backtest abbrechen
            </button>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" style="display: none; margin-top: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span class="card-subtitle">Fortschritt</span>
                <span id="progress-percent" class="card-subtitle" style="color: var(--neon-cyan); font-weight: 700;">0%</span>
            </div>
            <div style="background: rgba(0, 0, 0, 0.5); border: 1px solid var(--neon-cyan); border-radius: 4px; height: 24px; overflow: hidden;">
                <div id="progress-bar" style="background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta)); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                    <span id="progress-text" style="font-size: 0.75rem; color: white; font-weight: 700; text-shadow: 0 0 2px black;"></span>
                </div>
            </div>
        </div>

        <div id="backtest-status" class="card-subtitle mt-4" style="min-height: 2rem;"></div>
    </div>

    <div class="card card-neon-magenta mb-6">
        <h2 class="text-lg font-bold mb-6">Backtest Ergebnisse</h2>
        <div id="backtest-results" class="card-subtitle">
            Noch keine Backtest-Ergebnisse vorhanden.
        </div>
    </div>
</div>

<!-- Results Cards -->
<div class="stats-grid mt-6">
    <div class="card card-neon-green">
        <div class="card-gradient-overlay"></div>
        <div class="relative z-1">
            <div class="card-header">
                <span class="card-title-small">Total Return</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="card-icon" style="color: var(--neon-green);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
            </div>
            <div id="total-return" class="card-value card-value-neon-green">--</div>
            <div class="card-subtitle">Return</div>
        </div>
    </div>

    <div class="card card-neon-cyan">
        <div class="card-gradient-overlay"></div>
        <div class="relative z-1">
            <div class="card-header">
                <span class="card-title-small">Win Rate</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="card-icon" style="color: var(--neon-cyan);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            </div>
            <div id="win-rate" class="card-value card-value-neon-cyan">--</div>
            <div class="card-subtitle">Win Rate</div>
        </div>
    </div>

    <div class="card card-neon-violet">
        <div class="card-gradient-overlay"></div>
        <div class="relative z-1">
            <div class="card-header">
                <span class="card-title-small">Max Drawdown</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="card-icon" style="color: var(--neon-violet);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                </svg>
            </div>
            <div id="max-drawdown" class="card-value card-value-neon-violet">--</div>
            <div class="card-subtitle">Drawdown</div>
        </div>
    </div>

    <div class="card card-neon-magenta">
        <div class="card-gradient-overlay"></div>
        <div class="relative z-1">
            <div class="card-header">
                <span class="card-title-small">Sharpe Ratio</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="card-icon" style="color: var(--neon-magenta);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            </div>
            <div id="sharpe-ratio" class="card-value card-value-neon-magenta">--</div>
            <div class="card-subtitle">Sharpe</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/ui-helpers.js"></script>
<script>
// ============ INITIALIZATION ============

let currentBacktestId = null;
let statusPollInterval = null;

document.addEventListener('DOMContentLoaded', () => {
    // Set default dates (30 days ago to today)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);

    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
});

// ============ START BACKTEST ============

async function startBacktest() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const initialEquity = parseFloat(document.getElementById('initial-equity').value);

    if (!startDate || !endDate) {
        showError('Validierungsfehler', 'Bitte Start- und End-Datum angeben');
        return;
    }

    if (isNaN(initialEquity) || initialEquity < 1000) {
        showError('Validierungsfehler', 'Initial Equity muss mindestens $1000 sein');
        return;
    }

    // Start backtest via apiCall helper (shows spinner + error handling)
    const result = await apiCall('POST', '/api/backtesting/run', {
        start_date: startDate,
        end_date: endDate,
        initial_equity: initialEquity
    });

    if (result && result.backtest_id) {
        currentBacktestId = result.backtest_id;

        // Show progress bar
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('backtest-status').textContent = `âœ“ Backtest gestartet (ID: ${currentBacktestId})`;
        document.getElementById('backtest-results').textContent = 'Backtest lÃ¤uft... bitte warten';

        // Show/hide buttons
        document.getElementById('backtest-start-btn').classList.add('hidden');
        document.getElementById('backtest-cancel-btn').classList.remove('hidden');

        // Start polling for status (every 2 seconds)
        if (statusPollInterval) clearInterval(statusPollInterval);
        statusPollInterval = setInterval(() => pollBacktestStatus(currentBacktestId), 2000);

        // Initial poll
        pollBacktestStatus(currentBacktestId);
    }
}

// ============ POLL BACKTEST STATUS ============

async function pollBacktestStatus(backtestId) {
    try {
        const response = await fetch(`/api/backtesting/status/${backtestId}`);

        if (!response.ok) {
            showError('API Fehler', `Status Code: ${response.status}`);
            stopPolling();
            return;
        }

        const status = await response.json();
        const statusEl = document.getElementById('backtest-status');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressText = document.getElementById('progress-text');

        const progress = status.progress || 0;

        // Update progress bar
        progressBar.style.width = progress + '%';
        progressPercent.textContent = progress + '%';
        progressText.textContent = progress > 20 ? progress + '%' : '';

        if (status.status === 'running') {
            statusEl.textContent = `ðŸ”„ Backtest lÃ¤uft... (${progress}%)`;
        } else if (status.status === 'completed') {
            statusEl.textContent = 'âœ… Backtest abgeschlossen';
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';

            stopPolling();

            // Hide buttons
            document.getElementById('backtest-cancel-btn').classList.add('hidden');
            document.getElementById('backtest-start-btn').classList.remove('hidden');

            // Fetch results
            await fetchBacktestResults(backtestId);
        } else if (status.status === 'error') {
            statusEl.textContent = 'âŒ Backtest Fehler';
            showError('Backtest Fehler', status.error || 'Unbekannter Fehler');

            stopPolling();

            // Hide buttons
            document.getElementById('backtest-cancel-btn').classList.add('hidden');
            document.getElementById('backtest-start-btn').classList.remove('hidden');
        } else if (status.status === 'cancelled') {
            statusEl.textContent = 'â¹ï¸ Backtest abgebrochen';

            stopPolling();

            // Hide buttons
            document.getElementById('backtest-cancel-btn').classList.add('hidden');
            document.getElementById('backtest-start-btn').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error polling backtest status:', error);
        showError('Polling Fehler', error.message);
        stopPolling();
    }
}

// ============ CANCEL BACKTEST ============

async function cancelBacktest() {
    if (!currentBacktestId) return;

    if (!confirm('Backtest wirklich abbrechen?')) return;

    const result = await apiCall('DELETE', `/api/backtesting/cancel/${currentBacktestId}`);

    if (result) {
        document.getElementById('backtest-status').textContent = 'â¹ï¸ Backtest abgebrochen';
        stopPolling();

        document.getElementById('backtest-cancel-btn').classList.add('hidden');
        document.getElementById('backtest-start-btn').classList.remove('hidden');
    }
}

// ============ FETCH BACKTEST RESULTS ============

async function fetchBacktestResults(backtestId) {
    try {
        const response = await fetch(`/api/backtesting/results/${backtestId}`);

        if (!response.ok) {
            showError('Ergebnisse laden', `Status Code: ${response.status}`);
            return;
        }

        const results = await response.json();

        if (results.success === false) {
            showError('Ergebnisse laden', results.error || 'Fehler beim Abrufen der Ergebnisse');
            return;
        }

        // Display results
        displayResults(results);
    } catch (error) {
        console.error('Error fetching backtest results:', error);
        showError('Netzwerkfehler', error.message);
    }
}

// ============ DISPLAY RESULTS ============

function displayResults(results) {
    // Backend returns camelCase keys (confirmed in routes_backtesting.py:364-378)
    // Use them directly without defensive fallbacks

    const totalReturn = results.totalReturn || 0;
    const winRatePct = results.winRatePct || 0;
    const maxDrawdown = results.maxDrawdown || 0;
    const sharpeRatio = results.sharpeRatio || 0;

    // Update metric cards
    document.getElementById('total-return').textContent =
        (totalReturn >= 0 ? '+' : '') + totalReturn.toFixed(2) + '%';

    document.getElementById('win-rate').textContent = winRatePct.toFixed(2) + '%';

    document.getElementById('max-drawdown').textContent =
        (maxDrawdown >= 0 ? '+' : '') + maxDrawdown.toFixed(2) + '%';

    document.getElementById('sharpe-ratio').textContent = sharpeRatio.toFixed(2);

    // Update results details section
    const resultsEl = document.getElementById('backtest-results');

    const totalTrades = results.totalTrades || 0;
    const totalPnL = results.totalPnL || 0;
    const profitFactor = results.profitFactor || 0;
    const expectancy = results.expectancy || 0;
    const tradesPerDay = results.tradesPerDay || 0;

    resultsEl.innerHTML = `
        <div style="line-height: 1.8;">
            <div><strong>Total Trades:</strong> ${totalTrades}</div>
            <div><strong>Total PnL:</strong> $${totalPnL.toFixed(2)}</div>
            <div><strong>Trades per Day:</strong> ${tradesPerDay.toFixed(2)}</div>
            <div><strong>Profit Factor:</strong> ${profitFactor.toFixed(3)}</div>
            <div><strong>Expectancy:</strong> $${expectancy.toFixed(2)}</div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0, 255, 255, 0.3);">
                <div><strong>Risk Metrics:</strong></div>
                <div style="margin-left: 1rem; margin-top: 0.5rem;">
                    <div><strong>Max Drawdown:</strong> ${maxDrawdown.toFixed(2)}%</div>
                    <div><strong>Sharpe Ratio:</strong> ${sharpeRatio.toFixed(3)}</div>
                    <div><strong>Tail Loss (95%):</strong> $${(results.tailLoss95 || 0).toFixed(2)}</div>
                    <div><strong>Tail Loss (99%):</strong> $${(results.tailLoss99 || 0).toFixed(2)}</div>
                </div>
            </div>
        </div>
    `;

    showSuccess('Backtest abgeschlossen', 'Ergebnisse erfolgreich geladen');
}

// ============ HELPER FUNCTIONS ============

function stopPolling() {
    if (statusPollInterval) {
        clearInterval(statusPollInterval);
        statusPollInterval = null;
    }

    document.getElementById('progress-container').style.display = 'none';
}
</script>
{% endblock %}

